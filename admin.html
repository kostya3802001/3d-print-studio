<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ‚Äî 3D-PRINT STUDIO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: #000; margin: 0; padding: 0; font-family: sans-serif; color: #fff; }
        .admin-container { display: none; max-width: 800px; margin: 0 auto; padding: 40px 20px; flex-direction: column; align-items: center; }
        #loader { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 20px; color: #f39c12; font-weight: bold; text-transform: uppercase; }
        .admin-section { width: 100%; background: #0d0d0d; padding: 25px; border-radius: 12px; border: 2px solid #f39c12; margin-bottom: 30px; box-sizing: border-box; text-align: center; }
        .admin-section input, .admin-section textarea, .admin-section select { width: 100%; max-width: 500px; padding: 12px; margin: 10px auto; display: block; background: #151515; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        .collapsible { background-color: #1a1a1a; color: #f39c12; cursor: pointer; padding: 18px; width: 100%; max-width: 600px; border: 1px solid #333; text-align: center; outline: none; font-size: 18px; font-weight: bold; text-transform: uppercase; border-radius: 8px; margin-top: 15px; display: flex; justify-content: center; align-items: center; transition: 0.3s; position: relative; }
        .active-tab, .collapsible:hover { background-color: #222; border-color: #f39c12; }
        .collapsible:after { content: '\002B'; color: #f39c12; font-size: 24px; position: absolute; right: 20px; }
        .active-tab:after { content: "\2212"; }
        .content { width: 100%; max-width: 600px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #000; }
        .order-card, .item-card { background: #0d0d0d; border: 1px solid #222; padding: 15px; border-radius: 10px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .btn-group { display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap; }
        .btn-action { background: #27ae60; color: #fff; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-edit { background: #3498db; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-delete { background: #e74c3c; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-download { background: #e67e22; color: #fff; padding: 10px 15px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 13px; text-transform: uppercase; border: 1px solid #fff; }
        .btn-logout { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 20px; }
        .tg-link { color: #3498db; text-decoration: none; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div id="loader">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É...</div>

<div class="admin-container">
    <div class="admin-section">
        <h2 id="formTitle" style="margin-top:0; color:#f39c12;">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h2>
        <input type="hidden" id="editId">
        <input type="text" id="itemName" placeholder="–ù–∞–∑–≤–∞">
        <input type="text" id="itemPrice" placeholder="–¶—ñ–Ω–∞">
        <select id="itemCategory">
            <option value="figures">–§—ñ–≥—É—Ä–∫–∞</option>
            <option value="parts">–î–µ—Ç–∞–ª—å</option>
        </select>
        <textarea id="itemDesc" placeholder="–û–ø–∏—Å" rows="2"></textarea>
        <input type="text" id="itemImg" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏">
        <div class="btn-group">
            <button class="btn-action" id="saveItemBtn">–ó–ë–ï–†–ï–ì–¢–ò –¢–û–í–ê–†</button>
            <button id="cancelEditBtn" style="display:none; background:#444; color:#fff; border:none; padding:10px; border-radius:6px; cursor:pointer;">–°–ö–ê–°–£–í–ê–¢–ò</button>
        </div>
    </div>

    <button class="collapsible">–í—Å—ñ —Ç–æ–≤–∞—Ä–∏ –Ω–∞ —Å–∞–π—Ç—ñ</button>
    <div class="content"><div id="catalogList"></div></div>

    <button class="collapsible">–ù–æ–≤—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    <div class="content"><div id="listNew"></div></div>

    <button class="collapsible">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É —Ä–æ–±–æ—Ç—ñ</button>
    <div class="content"><div id="listActive"></div></div>

    <button class="btn-logout" id="logoutBtn">–í–ò–ô–¢–ò –ó –ü–ê–ù–ï–õ–Ü</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
        authDomain: "d-print-studio-25787.firebaseapp.com",
        projectId: "d-print-studio-25787",
        storageBucket: "d-print-studio-25787.firebasestorage.app",
        messagingSenderId: "671010955757",
        appId: "1:671010955757:web:633317a7073d5d6f6c07e4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "join.the.game.notik.fols@gmail.com";
    const botToken = "8252771598:AAGP_fn_voqMi9OZXMhd-Ch9H0mFRMqpPGw";
    const chatId = "836468275";

    async function sendTelegramNotify(order) {
        const text = `üöÄ –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø!\n\n` +
                     `üì¶ –¢–æ–≤–∞—Ä: ${order.name || '–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–µ'}\n` +
                     `üí∞ –¶—ñ–Ω–∞: ${order.price || '–†–∞—Ö—É—î–º–æ'} –≥—Ä–Ω\n` +
                     `üì± –ö–æ–Ω—Ç–∞–∫—Ç: ${order.telegram}\n` +
                     `üìù –û–ø–∏—Å: ${order.desc || order.description || '–í—ñ–¥—Å—É—Ç–Ω—ñ–π'}`;
        try {
            await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, text: text })
            });
        } catch (e) { console.error("TG Error:", e); }
    }

    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('loader').style.display = "none";
            document.querySelector('.admin-container').style.display = "flex";
            initAdmin();
        } else {
            window.location.href = "login.html";
        }
    });

    function initAdmin() {
        document.querySelectorAll(".collapsible").forEach(button => {
            button.onclick = function() {
                this.classList.toggle("active-tab");
                const content = this.nextElementSibling;
                content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
            };
        });

        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        const nameInp = document.getElementById('itemName'), priceInp = document.getElementById('itemPrice'),
              catInp = document.getElementById('itemCategory'), descInp = document.getElementById('itemDesc'),
              imgInp = document.getElementById('itemImg'), editIdInp = document.getElementById('editId');

        // –ö–∞—Ç–∞–ª–æ–≥
        onSnapshot(collection(db, "catalog"), (snap) => {
            const list = document.getElementById('catalogList');
            list.innerHTML = "";
            snap.forEach(d => {
                const i = d.data();
                const div = document.createElement('div');
                div.className = "item-card";
                div.innerHTML = `<div><b>${i.name}</b> (${i.price} –≥—Ä–Ω)</div>
                    <div class="btn-group">
                        <button class="btn-edit">–†–µ–¥.</button>
                        <button class="btn-delete">–í–∏–¥.</button>
                    </div>`;
                div.querySelector('.btn-edit').onclick = () => {
                    editIdInp.value = d.id; nameInp.value = i.name; priceInp.value = i.price;
                    catInp.value = i.category; descInp.value = i.desc; imgInp.value = i.img;
                    document.getElementById('formTitle').innerText = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è";
                    document.getElementById('cancelEditBtn').style.display = "block";
                    window.scrollTo({top:0, behavior:'smooth'});
                };
                div.querySelector('.btn-delete').onclick = () => confirm("–í–∏–¥–∞–ª–∏—Ç–∏?") && deleteDoc(doc(db, "catalog", d.id));
                list.appendChild(div);
            });
        });

        // –ó–ê–ú–û–í–õ–ï–ù–ù–Ø
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
            const boxNew = document.getElementById('listNew'), boxActive = document.getElementById('listActive');
            
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const o = change.doc.data();
                    const orderTime = o.timestamp?.toMillis();
                    const now = Date.now();
                    if (orderTime && (now - orderTime) < 10000) sendTelegramNotify(o);
                }
            });

            boxNew.innerHTML = ""; boxActive.innerHTML = "";
            snap.forEach(d => {
                const o = d.data(); if (o.archivedByAdmin) return;
                const isWorking = o.status === "–í —Ä–æ–±–æ—Ç—ñ";
                const card = document.createElement('div');
                card.className = "order-card";
                
                // --- –†–û–ó–®–ò–†–ï–ù–ò–ô –ü–û–®–£–ö –§–ê–ô–õ–£ ---
                // –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Å—ñ –º–æ–∂–ª–∏–≤—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏, –∫—É–¥–∏ —Å–∞–π—Ç –º—ñ–≥ –∑–∞–ø–∏—Å–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                const fileLink = o.downloadURL || o.fileUrl || o.fileURL || o.file || o.stlUrl || o.url || o.imageUrl || null;
                const finalDesc = o.desc || o.description || '–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π';
                
                card.innerHTML = `
                    <div style="flex-grow: 1; text-align: left;">
                        <b style="color:#f39c12; font-size: 16px;">${o.name || '–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è'}</b><br>
                        
                        <div style="background: #111; padding: 10px; border-radius: 5px; margin: 8px 0; border-left: 3px solid #f39c12; font-size: 13px; color: #ddd;">
                            <strong>–î–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</strong><br>
                            ${finalDesc}
                        </div>

                        <a href="https://t.me/${o.telegram?.replace('@','')}" target="_blank" class="tg-link">‚úàÔ∏è TG: ${o.telegram || '–ù—ñ'}</a>
                    </div>
                    <div class="btn-group">
                        <span style="color: #fff; font-weight: bold; margin-right: 10px;">${o.price || '—Ä–∞—Ö—É—î–º–æ'} –≥—Ä–Ω</span>
                        
                        ${fileLink ? 
                            `<a href="${fileLink}" target="_blank" class="btn-download">‚¨áÔ∏è –í–Ü–î–ö–†–ò–¢–ò –§–ê–ô–õ</a>` : 
                            `<span style="color: #555; font-size: 11px; border: 1px dashed #333; padding: 5px;">–§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>`
                        }
                        
                        ${!isWorking ? `<button class="btn-action btn-upd">–ü–†–ò–ô–ù–Ø–¢–ò</button>` : 'üëå'}
                        <button class="btn-delete btn-arch" style="background:#444">–ê–†–•–Ü–í</button>
                    </div>`;

                if(!isWorking) card.querySelector('.btn-upd').onclick = () => updateDoc(doc(db, "orders", d.id), {status: "–í —Ä–æ–±–æ—Ç—ñ"});
                card.querySelector('.btn-arch').onclick = () => updateDoc(doc(db, "orders", d.id), {archivedByAdmin: true});
                if (isWorking) boxActive.appendChild(card); else boxNew.appendChild(card);
            });
        });

        document.getElementById('saveItemBtn').onclick = async () => {
            const data = { name: nameInp.value, price: priceInp.value, category: catInp.value, desc: descInp.value, img: imgInp.value, timestamp: new Date() };
            editIdInp.value ? await updateDoc(doc(db, "catalog", editIdInp.value), data) : await addDoc(collection(db, "catalog"), data);
            resetForm();
        };

        function resetForm() {
            editIdInp.value = ""; nameInp.value = ""; priceInp.value = ""; descInp.value = ""; imgInp.value = "";
            document.getElementById('formTitle').innerText = "–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä";
            document.getElementById('cancelEditBtn').style.display = "none";
        }
        document.getElementById('cancelEditBtn').onclick = resetForm;
    }
</script>
</body>
</html>
