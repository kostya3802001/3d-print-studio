
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Адмін панель</title>
<link rel="stylesheet" href="ui.css"></head>
<body>

<h1>Адмін панель</h1>
<ul id="orders"></ul>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  updateDoc, 
  doc 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { 
  getStorage, 
  ref, 
  getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
  authDomain: "d-print-studio-25787.firebaseapp.com",
  projectId: "d-print-studio-25787",
  storageBucket: "d-print-studio-25787.firebasestorage.app"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const ADMIN_EMAIL = "join.the.game.notik.fols@gmail.com";

onAuthStateChanged(auth, user => {
  if(!user || user.email !== ADMIN_EMAIL){
    window.location.href = "index.html";
    return;
  }

  onSnapshot(collection(db,"orders"), snap => {
    orders.innerHTML = "";
    snap.forEach(d => {
      const o = d.data();
      const li = document.createElement("li");

      const fileRef = ref(storage, `orders/${d.id}.stl`);

      li.innerHTML = `
        <b>${o.email}</b><br>
        ${o.material} / ${o.color}<br>
        Статус: <b>${o.status}</b><br>
        <a id="dl-${d.id}" target="_blank">Скачати STL</a><br><br>
        <button data-s="Майстер взяв у роботу">Взяти у роботу</button>
        <button data-s="Виконується друк">Почати друк</button>
        <button data-s="Готово">Готово</button>
        <hr>
      `;

      getDownloadURL(fileRef).then(url => {
        li.querySelector(`#dl-${d.id}`).href = url;
      });

      li.querySelectorAll("button").forEach(btn => {
        btn.onclick = () =>
          updateDoc(doc(db,"orders",d.id),{status: btn.dataset.s});
      });

      orders.appendChild(li);
    });
  });
});
</script>

</body>
</html>
