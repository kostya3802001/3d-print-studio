<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
        authDomain: "d-print-studio-25787.firebaseapp.com",
        projectId: "d-print-studio-25787",
        storageBucket: "d-print-studio-25787.firebasestorage.app",
        messagingSenderId: "671010955757",
        appId: "1:671010955757:web:633317a7073d5d6f6c07e4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "join.the.game.notik.fols@gmail.com";
    const adminContainer = document.querySelector('.admin-container');

    // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å–µ –¥–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
    adminContainer.style.opacity = "0";

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("–£–≤—ñ–π—à–æ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á:", user.email);
            if (user.email === ADMIN_EMAIL) {
                console.log("–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ!");
                adminContainer.style.display = "flex";
                adminContainer.style.opacity = "1";
                initAdminPanel();
            } else {
                console.error("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ: –Ω–µ —Ç–æ–π email");
                alert("–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏.");
                window.location.href = "index.html"; 
            }
        } else {
            console.log("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π");
            window.location.href = "login.html"; 
        }
    });

    function initAdminPanel() {
        // –õ–æ–≥—ñ–∫–∞ –∞–∫–æ—Ä–¥–µ–æ–Ω–∞ (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞)
        document.querySelectorAll(".collapsible").forEach(button => {
            button.onclick = function() {
                this.classList.toggle("active-tab");
                const content = this.nextElementSibling;
                if (content.style.maxHeight && content.style.maxHeight !== "0px") {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            };
        });

        // –ï–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º–∏
        const nameInp = document.getElementById('itemName');
        const priceInp = document.getElementById('itemPrice');
        const catInp = document.getElementById('itemCategory');
        const descInp = document.getElementById('itemDesc');
        const imgInp = document.getElementById('itemImg');
        const editIdInp = document.getElementById('editId');

        // –ö–∞—Ç–∞–ª–æ–≥
        onSnapshot(collection(db, "catalog"), (snap) => {
            const list = document.getElementById('catalogList');
            list.innerHTML = "";
            snap.forEach(d => {
                const i = d.data();
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <div><b>${i.name}</b> (${i.price} –≥—Ä–Ω)</div>
                    <div class="btn-group">
                        <button class="btn-edit" data-id="${d.id}">–†–µ–¥.</button>
                        <button class="btn-delete" data-id="${d.id}">–í–∏–¥.</button>
                    </div>`;
                
                div.querySelector('.btn-edit').onclick = () => startEdit(d.id, i.name, i.price, i.category, i.desc, i.img);
                div.querySelector('.btn-delete').onclick = () => deleteItem(d.id);
                list.appendChild(div);
            });
        });

        // –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
            const boxNew = document.getElementById('listNew');
            const boxActive = document.getElementById('listActive');
            boxNew.innerHTML = ""; boxActive.innerHTML = "";

            snap.forEach(d => {
                const o = d.data();
                if (o.archivedByAdmin) return;
                const isWorking = o.status === "–í —Ä–æ–±–æ—Ç—ñ";
                const fileLink = o.fileUrl || o.fileURL || o.file;
                
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <div>
                        <b style="color:#f39c12;">${o.name || '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è'}</b><br>
                        <a href="https://t.me/${o.telegram?.replace('@', '')}" target="_blank" class="tg-link">‚úàÔ∏è TG: ${o.telegram || '–ù—ñ'}</a>
                        <small>${o.material || ''}</small>
                    </div>
                    <div class="btn-group">
                        ${fileLink ? `<a href="${fileLink}" target="_blank" class="btn-download">üìÇ –ú–û–î–ï–õ–¨</a>` : ''}
                        <button class="btn-chat">–ß–ê–¢</button>
                        ${!isWorking ? `<button class="btn-accept btn-action">–ü–†–ò–ô–ù–Ø–¢–ò</button>` : 'üëå'}
                        <button class="btn-archive btn-delete" style="background:#555">–ê–†–•–Ü–í</button>
                    </div>`;

                card.querySelector('.btn-chat').onclick = () => alert("–ß–∞—Ç –∑: " + o.userId);
                if (!isWorking) card.querySelector('.btn-accept').onclick = () => updateDoc(doc(db, "orders", d.id), { status: '–í —Ä–æ–±–æ—Ç—ñ' });
                card.querySelector('.btn-archive').onclick = () => updateDoc(doc(db, "orders", d.id), { archivedByAdmin: true });

                if (isWorking) boxActive.appendChild(card);
                else boxNew.appendChild(card);
            });
        });

        function startEdit(id, n, p, c, d, i) {
            editIdInp.value = id; nameInp.value = n; priceInp.value = p; catInp.value = c; descInp.value = d; imgInp.value = i;
            document.getElementById('formTitle').innerText = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è";
            document.getElementById('cancelEditBtn').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteItem(id) {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) await deleteDoc(doc(db, "catalog", id));
        }

        document.getElementById('saveItemBtn').onclick = async () => {
            const data = { name: nameInp.value, price: priceInp.value, category: catInp.value, desc: descInp.value, img: imgInp.value, timestamp: new Date() };
            if(editIdInp.value) await updateDoc(doc(db, "catalog", editIdInp.value), data);
            else await addDoc(collection(db, "catalog"), data);
            resetForm();
        };

        function resetForm() {
            editIdInp.value = ""; nameInp.value = ""; priceInp.value = ""; descInp.value = ""; imgInp.value = "";
            document.getElementById('formTitle').innerText = "–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä";
            document.getElementById('cancelEditBtn').style.display = "none";
        }
        document.getElementById('cancelEditBtn').onclick = resetForm;
    }
</script>
