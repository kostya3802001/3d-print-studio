<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
        authDomain: "d-print-studio-25787.firebaseapp.com",
        projectId: "d-print-studio-25787",
        storageBucket: "d-print-studio-25787.firebasestorage.app",
        messagingSenderId: "671010955757",
        appId: "1:671010955757:web:633317a7073d5d6f6c07e4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- –ü–ï–†–ï–í–Ü–†–ö–ê –î–û–°–¢–£–ü–£ ---
    const ADMIN_EMAIL = "join.the.game.notik.fols@gmail.com";
    const adminContainer = document.querySelector('.admin-container');

    // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—Ö–æ–≤–∞—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç, –ø–æ–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
    adminContainer.style.display = "none";

    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            // –Ø–∫—â–æ —Ü–µ –≤–∏ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å
            adminContainer.style.display = "flex";
            initAdminPanel(); 
        } else {
            // –Ø–∫—â–æ —Ö—Ç–æ—Å—å —ñ–Ω—à–∏–π ‚Äî –≤–∏–∫–∏–¥–∞—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ö–æ–¥—É
            alert("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ! –í–∏ –Ω–µ —î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.");
            window.location.href = "login.html"; // –í–∫–∞–∂—ñ—Ç—å —à–ª—è—Ö –¥–æ –≤–∞—à–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ª–æ–≥—ñ–Ω—É
        }
    });

    // –û–±–µ—Ä–Ω–µ–º–æ –≤—Å—é –≤–∞—à—É –ª–æ–≥—ñ–∫—É —É —Ñ—É–Ω–∫—Ü—ñ—é, —è–∫–∞ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞
    function initAdminPanel() {
        // –õ–æ–≥—ñ–∫–∞ –∞–∫–æ—Ä–¥–µ–æ–Ω–∞
        document.querySelectorAll(".collapsible").forEach(button => {
            button.onclick = function() {
                this.classList.toggle("active-tab");
                var content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            };
        });

        const nameInp = document.getElementById('itemName');
        const priceInp = document.getElementById('itemPrice');
        const catInp = document.getElementById('itemCategory');
        const descInp = document.getElementById('itemDesc');
        const imgInp = document.getElementById('itemImg');
        const editIdInp = document.getElementById('editId');

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤
        onSnapshot(collection(db, "catalog"), (snap) => {
            const list = document.getElementById('catalogList');
            list.innerHTML = "";
            snap.forEach(d => {
                const i = d.data();
                list.innerHTML += `
                    <div class="item-card">
                        <div><b>${i.name}</b> (${i.price} –≥—Ä–Ω)</div>
                        <div class="btn-group">
                            <button class="btn-edit" onclick="startEdit('${d.id}', '${i.name}', '${i.price}', '${i.category}', '${i.desc}', '${i.img}')">–†–µ–¥.</button>
                            <button class="btn-delete" onclick="deleteItem('${d.id}')">–í–∏–¥.</button>
                        </div>
                    </div>`;
            });
        });

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
            const boxNew = document.getElementById('listNew');
            const boxActive = document.getElementById('listActive');
            boxNew.innerHTML = ""; boxActive.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                if (o.archivedByAdmin) return;
                const isWorking = o.status === "–í —Ä–æ–±–æ—Ç—ñ";
                const fileLink = o.fileUrl || o.fileURL || o.file;
                const downloadBtn = fileLink ? `<a href="${fileLink}" target="_blank" class="btn-download">üìÇ –ú–û–î–ï–õ–¨</a>` : `<span style="color:#444; font-size:11px;">–ù–µ–º–∞—î —Ñ–∞–π–ª—É</span>`;
                const tgClean = o.telegram ? o.telegram.replace('@', '').trim() : '';
                const tgAction = `https://t.me/${tgClean}`;

                const card = `
                    <div class="order-card">
                        <div>
                            <b style="color:#f39c12;">${o.name || '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è'}</b><br>
                            <a href="${tgAction}" target="_blank" class="tg-link">‚úàÔ∏è TG: ${o.telegram || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</a>
                            <small>${o.material || ''} | ${o.userEmail || ''}</small>
                        </div>
                        <div class="btn-group">
                            ${downloadBtn} 
                            <button class="btn-chat" onclick="openChat('${o.userId}', '${o.name}')">–ß–ê–¢</button>
                            ${!isWorking ? `<button class="btn-action" onclick="updOrder('${d.id}', '–í —Ä–æ–±–æ—Ç—ñ')">–ü–†–ò–ô–ù–Ø–¢–ò</button>` : 'üëå'}
                            <button class="btn-delete" style="background:#555" onclick="archiveOrder('${d.id}')">–ê–†–•–Ü–í</button>
                        </div>
                    </div>`;
                if (isWorking) boxActive.innerHTML += card;
                else boxNew.innerHTML += card;
            });
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        window.startEdit = (id, n, p, c, d, i) => {
            editIdInp.value = id; nameInp.value = n; priceInp.value = p; catInp.value = c; descInp.value = d; imgInp.value = i;
            document.getElementById('formTitle').innerText = "–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è";
            document.getElementById('cancelEditBtn').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.updOrder = async (id, s) => { await updateDoc(doc(db, "orders", id), { status: s }); };
        window.archiveOrder = async (id) => { await updateDoc(doc(db, "orders", id), { archivedByAdmin: true }); };
        window.deleteItem = async (id) => { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä?")) await deleteDoc(doc(db, "catalog", id)); };

        document.getElementById('saveItemBtn').onclick = async () => {
            const data = { name: nameInp.value, price: priceInp.value, category: catInp.value, desc: descInp.value, img: imgInp.value, timestamp: new Date() };
            if(editIdInp.value) await updateDoc(doc(db, "catalog", editIdInp.value), data);
            else await addDoc(collection(db, "catalog"), data);
            resetForm();
        };

        function resetForm() {
            editIdInp.value = ""; nameInp.value = ""; priceInp.value = ""; descInp.value = ""; imgInp.value = "";
            document.getElementById('formTitle').innerText = "–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä";
            document.getElementById('cancelEditBtn').style.display = "none";
        }
        document.getElementById('cancelEditBtn').onclick = resetForm;
    }
                </script>
                
