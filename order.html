
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Замовити друк</title>
<link rel="stylesheet" href="ui.css"></head>
<body>

<h1>Замовити друк</h1>

<form id="orderForm">
  <input id="material" placeholder="Матеріал" required><br><br>
  <input id="color" placeholder="Колір" required><br><br>
  <input type="file" id="stl" accept=".stl" required><br><br>
  <textarea id="comment" placeholder="Коментар"></textarea><br><br>
  <button type="submit">Замовити</button>

<hr>
<label>Кількість (г): <input id="weight" type="number" min="1" required></label><br><br>
<p>Ціна: <b><span id="price">0</span> ₴</b></p>

</form>

<p id="info"></p>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
  authDomain: "d-print-studio-25787.firebaseapp.com",
  projectId: "d-print-studio-25787",
  storageBucket: "d-print-studio-25787.firebasestorage.app"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let user = null;

onAuthStateChanged(auth, u => {
  if(!u){
    window.location.href = "login.html";
    return;
  }
  user = u;
});

orderForm.addEventListener("submit", async e => {
  e.preventDefault();
  if(!user) return;

  const file = stl.files[0];
  if(!file || !file.name.endsWith(".stl")){
    alert("Тільки STL");
    return;
  }

  info.textContent = "Завантаження...";

  const docRef = await addDoc(collection(db,"orders"),{
    uid: user.uid,
    email: user.email,
    material: material.value,
    color: color.value,
    comment: comment.value,
    status: "Очікує обробки",
    createdAt: serverTimestamp()
  });

  const storageRef = ref(storage, `orders/${docRef.id}.stl`);
  await uploadBytes(storageRef, file);

  info.textContent = "Замовлення створено";
  orderForm.reset();
});
</script>


<script>
const PRICE_PER_GRAM = 5;
const weightInput = document.getElementById("weight");
const priceEl = document.getElementById("price");

weightInput.addEventListener("input", ()=>{
  const w = Number(weightInput.value)||0;
  priceEl.textContent = w * PRICE_PER_GRAM;
});
</script>


<script type="module">
import * as THREE from "https://unpkg.com/three@0.155.0/build/three.module.js";
import { STLLoader } from "https://unpkg.com/three@0.155.0/examples/jsm/loaders/STLLoader.js";

const MAX = 256;

stl.addEventListener("change", () => {
  const file = stl.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const loader = new STLLoader();
    const geom = loader.parse(e.target.result);
    geom.computeBoundingBox();
    const b = geom.boundingBox;

    const sizeX = b.max.x - b.min.x;
    const sizeY = b.max.y - b.min.y;
    const sizeZ = b.max.z - b.min.z;

    if(sizeX > MAX || sizeY > MAX || sizeZ > MAX){
      alert(`Модель завелика: ${sizeX.toFixed(1)} × ${sizeY.toFixed(1)} × ${sizeZ.toFixed(1)} мм`);
      stl.value = "";
    }
  };
  reader.readAsArrayBuffer(file);
});
</script>

</body>
</html>
