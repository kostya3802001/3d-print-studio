<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Замовити 3D-друк — 3D-PRINT STUDIO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Стилі для прогресу завантаження */
        .progress-container { width: 100%; background: #222; margin: 15px 0; display: none; border-radius: 8px; overflow: hidden; height: 12px; border: 1px solid #444; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #f39c12, #e67e22); transition: width 0.3s; }
        #fileStatus { font-size: 14px; color: #f39c12; font-weight: bold; text-align: center; margin-top: 5px; }
        input[type="file"] { background: #1a1a1a; border: 1px dashed #555; padding: 10px; cursor: pointer; width: 100%; color: #888; }
    </style>
</head>
<body>

<header>
    <div class="logo"><img src="log img/Логотип.jpg" alt="Logo"> 3D-PRINT STUDIO</div>
    <nav>
        <a href="index.html" data-ua="Головна" data-pl="Główna">Головна</a>
        <a href="figures.html" data-ua="Фігурки" data-pl="Figurki">Фігурки</a>
        <a href="parts.html" data-ua="Деталі" data-pl="Części">Деталі</a>
        <a href="order.html" class="active" data-ua="Замовити" data-pl="Zamów">Замовити</a>
        <a href="login.html" id="accountLink" data-ua="Кабінет" data-pl="Gabinet">Кабінет</a>
        <span class="lang" id="langToggle" style="cursor:pointer; margin-left: 10px;">UA | PL</span>
    </nav>
</header>

<section class="section">
    <h1 class="section-title" data-ua="Замовлення 3D-друку" data-pl="Zamówienie druku 3D" style="text-align: center;">Замовлення 3D-друку</h1>

    <div class="grid" style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
        <div class="card" style="max-width: 550px; width: 100%;">
            <div class="card-body">
                <h3 data-ua="Дані для замовлення" data-pl="Dane zamówienia" style="text-align: center; color: #f39c12;">Дані для замовлення</h3>
                
                <form id="orderForm">
                    <label data-ua="Ваше імʼя" data-pl="Twoje imię">Ваше імʼя</label>
                    <input type="text" id="custName" placeholder="Імʼя" required>

                    <label data-ua="Email або Telegram" data-pl="Email lub Telegram">Email або Telegram</label>
                    <input type="text" id="custContact" placeholder="@username" required>

                    <label data-ua="Матеріал" data-pl="Materiał">Матеріал</label>
                    <select id="material">
                        <option>PLA (Стандарт)</option>
                        <option>PETG (Міцний)</option>
                        <option>ABS / ASA</option>
                        <option>TPU (Гнучкий)</option>
                    </select>

                    <label data-ua="Прикріпити STL файл" data-pl="Załącz plik STL">Прикріпити STL файл</label>
                    <input type="file" id="fileInput" accept=".stl,.obj,.zip,.rar" required>
                    
                    <div class="progress-container" id="pContainer"><div class="progress-bar" id="pBar"></div></div>
                    <div id="fileStatus"></div>

                    <label data-ua="Опис замовлення" data-pl="Opis zamówienia" style="margin-top:15px; display:block;">Опис замовлення</label>
                    <textarea id="orderDesc" placeholder="Колір, розміри, заповнення..." rows="4"></textarea>

                    <button type="submit" id="submitBtn" class="btn" style="margin-top:20px; width:100%; font-weight: bold;" data-ua="Надіслати замовлення" data-pl="Wyślij zamówienie">
                        Надіслати замовлення
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<script src="lang.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
    authDomain: "d-print-studio-25787.firebaseapp.com",
    projectId: "d-print-studio-25787",
    storageBucket: "d-print-studio-25787.firebasestorage.app",
    messagingSenderId: "671010955757",
    appId: "1:671010955757:web:633317a7073d5d6f6c07e4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    const link = document.getElementById('accountLink');
    if (user && link) { link.href = "account.html"; link.innerText = "Мій Профіль"; }
  });

  document.getElementById('orderForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const file = document.getElementById('fileInput').files[0];
    const pBar = document.getElementById('pBar');
    const pContainer = document.getElementById('pContainer');
    const fileStatus = document.getElementById('fileStatus');

    if (!file) { alert("Будь ласка, виберіть файл!"); return; }

    btn.disabled = true;
    btn.innerText = "Завантаження...";
    pContainer.style.display = "block";

    try {
        // 1. Завантаження файлу
        const storageRef = ref(storage, 'orders/' + Date.now() + "_" + file.name);
        const uploadTask = uploadBytesResumable(storageRef, file);

        const fileUrl = await new Promise((resolve, reject) => {
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    pBar.style.width = progress + "%";
                    fileStatus.innerText = "Файл: " + Math.round(progress) + "%";
                }, 
                (error) => reject(error), 
                () => getDownloadURL(uploadTask.snapshot.ref).then(resolve)
            );
        });

        // 2. Запис у базу
        await addDoc(collection(db, "orders"), {
            name: document.getElementById('custName').value,
            contact: document.getElementById('custContact').value,
            material: document.getElementById('material').value,
            description: document.getElementById('orderDesc').value,
            fileUrl: fileUrl,
            timestamp: new Date(),
            userId: auth.currentUser ? auth.currentUser.uid : "guest"
        });

        alert("Замовлення успішно прийнято!");
        e.target.reset();
        pContainer.style.display = "none";
        fileStatus.innerText = "";
        
    } catch (error) {
        alert("Помилка: " + error.message);
        console.error(error);
    } finally {
        btn.disabled = false;
        btn.innerText = "Надіслати замовлення";
    }
  };
</script>

</body>
</html>
