<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-ua="Замовити 3D-друк — 3D-PRINT STUDIO" data-pl="Zamów druk 3D — 3D-PRINT STUDIO">Замовити 3D-друк — 3D-PRINT STUDIO</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .progress-bar { width: 0%; height: 5px; background: #f39c12; transition: width 0.3s; margin-top: 5px; border-radius: 5px; }
        .progress-container { width: 100%; background: #222; margin-top: 10px; display: none; }
        #fileStatus { font-size: 12px; color: #f39c12; margin-top: 5px; }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <img src="log img/Логотип.jpg" alt="Logo">
        3D-PRINT STUDIO
    </div>
    <nav>
        <a href="index.html" data-ua="Головна" data-pl="Główna">Головна</a>
        <a href="figures.html" data-ua="Фігурки" data-pl="Figurki">Фігурки</a>
        <a href="parts.html" data-ua="Деталі" data-pl="Części">Деталі</a>
        <a href="order.html" class="active" data-ua="Замовити" data-pl="Zamów">Замовити</a>
        <a href="login.html" id="accountLink" data-ua="Кабінет" data-pl="Gabinet">Кабінет</a>
        <span class="lang" style="cursor:pointer">UA | PL</span>
    </nav>
</header>

<section class="section">
    <h1 class="section-title" data-ua="Замовлення 3D-друку" data-pl="Zamówienie druku 3D">Замовлення 3D-друку</h1>

    <div class="grid">
        <div class="card">
            <div class="card-body">
                <h3 data-ua="Дані для прорахунку" data-pl="Dane do kalkulacji">Дані для прорахунку</h3>
                <form id="orderForm">
                    <label data-ua="Ваше імʼя" data-pl="Twoje imię">Ваше імʼя</label>
                    <input type="text" id="custName" placeholder="Імʼя" required>

                    <label data-ua="Email або Telegram" data-pl="Email lub Telegram">Email або Telegram</label>
                    <input type="text" id="custContact" placeholder="@username або email" required>

                    <label data-ua="Тип замовлення" data-pl="Typ zamówienia">Тип замовлення</label>
                    <select id="orderType">
                        <option value="STL Print">Друк за STL</option>
                        <option value="Technical Part">Технічна деталь</option>
                        <option value="Figure">Фігурка</option>
                    </select>

                    <label data-ua="Матеріал" data-pl="Materiał">Матеріал</label>
                    <select id="material">
                        <option>PLA</option>
                        <option>PETG</option>
                        <option>ABS / ASA</option>
                        <option>TPU (Гнучкий)</option>
                        <option>PA (Нейлон)</option>
                    </select>

                    <label data-ua="Прикріпити STL файл" data-pl="Załącz plik STL">Прикріпити STL файл</label>
                    <input type="file" id="fileInput" accept=".stl,.obj,.zip,.rar">
                    <div class="progress-container" id="pContainer"><div class="progress-bar" id="pBar"></div></div>
                    <div id="fileStatus"></div>

                    <label data-ua="Опис замовлення" data-pl="Opis zamówienia" style="margin-top:15px; display:block;">Опис замовлення</label>
                    <textarea id="orderDesc" placeholder="Вкажіть розміри, колір або інші побажання" rows="4"></textarea>

                    <button type="submit" id="submitBtn" class="btn" style="margin-top:20px;width:100%;" data-ua="Надіслати замовлення" data-pl="Wyślij zamówienie">
                        Надіслати замовлення
                    </button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h3 data-ua="Як проходить замовлення" data-pl="Jak przebiega zamówienie">Як проходить замовлення</h3>
                <div class="step"><span>01</span><p data-ua="Ви надсилаєте STL або опис" data-pl="Wysyłasz STL lub opis">Ви надсилаєте STL або опис</p></div>
                <div class="step"><span>02</span><p data-ua="Ми робимо точний прорахунок" data-pl="Robimy dokładną kalkulację">Ми робимо точний прорахунок</p></div>
                <div class="step"><span>03</span><p data-ua="Ви підтверджуєте замовлення" data-pl="Potwierdzasz zamówienie">Ви підтверджуєте замовлення</p></div>
                <div class="step"><span>04</span><p data-ua="Друк та відправка" data-pl="Druk i wysyłka">Друк та відправка</p></div>
            </div>
        </div>
    </div>
</section>

<script src="lang.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgAl6GL0DQOhE-JpPAABzb4yvOctfpXXI",
    authDomain: "d-print-studio-25787.firebaseapp.com",
    projectId: "d-print-studio-25787",
    storageBucket: "d-print-studio-25787.firebasestorage.app",
    messagingSenderId: "671010955757",
    appId: "1:671010955757:web:633317a7073d5d6f6c07e4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  onAuthStateChanged(auth, (user) => {
    const link = document.getElementById('accountLink');
    if (user) {
      link.href = "account.html";
      link.innerText = "Мій Профіль";
    }
  });

  document.getElementById('orderForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const file = document.getElementById('fileInput').files[0];
    const pBar = document.getElementById('pBar');
    const pContainer = document.getElementById('pContainer');
    const fileStatus = document.getElementById('fileStatus');

    btn.disabled = true;
    btn.innerText = "Обробка...";

    let uploadedFileUrl = "";

    try {
        // Якщо файл вибрано, завантажуємо його в Storage
        if (file) {
            pContainer.style.display = "block";
            const storageRef = ref(storage, 'orders/' + Date.now() + "_" + file.name);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadedFileUrl = await new Promise((resolve, reject) => {
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        pBar.style.width = progress + "%";
                        fileStatus.innerText = "Завантаження файлу: " + Math.round(progress) + "%";
                    }, 
                    (error) => reject(error), 
                    () => getDownloadURL(uploadTask.snapshot.ref).then(resolve)
                );
            });
        }

        // Зберігаємо замовлення в Firestore
        await addDoc(collection(db, "orders"), {
            name: document.getElementById('custName').value,
            contact: document.getElementById('custContact').value,
            type: document.getElementById('orderType').value,
            material: document.getElementById('material').value,
            description: document.getElementById('orderDesc').value,
            fileUrl: uploadedFileUrl, // Посилання на файл для адміна
            status: "Новий запит",
            timestamp: new Date(),
            userId: auth.currentUser ? auth.currentUser.uid : "guest"
        });

        alert("Замовлення успішно надіслано!");
        e.target.reset();
        pContainer.style.display = "none";
        fileStatus.innerText = "";
    } catch (error) {
        alert("Помилка: " + error.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "Надіслати замовлення";
    }
  };
</script>

</body>
</html>
